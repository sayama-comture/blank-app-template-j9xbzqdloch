# マイグレーションガイド（v0 から v1）

すでに以前のバージョン（~`0.4.x`）の Bedrock Chat を使用している場合は、以下の手順に従ってマイグレーションする必要があります。

## なぜ実行する必要があるのか？

この大規模なアップデートには、重要なセキュリティ更新が含まれています。

- ベクターデータベース（Aurora PostgreSQLの pgvector）のストレージが暗号化され、デプロイ時に置き換えが発生します。これは、既存のベクターアイテムが削除されることを意味します。
- ボット作成可能なユーザーを制限するために、`CreatingBotAllowed` Cognitoユーザーグループを導入しました。既存のユーザーはデフォルトでこのグループに属していないため、ボット作成の権限を付与したい場合は、手動で権限を追加する必要があります。詳細は：[ボットのパーソナライズ](../../README.md#bot-personalization)

## 前提条件

[データベース移行ガイド](./DATABASE_MIGRATION_ja-JP.md)を読み、アイテムを復元する方法を決定してください。

## 手順

### ベクターストアの移行

- ターミナルを開き、プロジェクトディレクトリに移動します
- デプロイしたいブランチをプルします。以下は目的のブランチ（この場合は `v1`）にチェックアウトし、最新の変更をプルします：

```sh
git fetch
git checkout v1
git pull origin v1
```

- DMSでアイテムを復元する場合、パスワードローテーションを無効にし、データベースにアクセスするためのパスワードをメモしてください。移行スクリプト([migrate_v0_v1.py](./migrate_v0_v1.py))で復元する場合、パスワードをメモする必要はありません。
- CloudFormationが既存のAuroraクラスターを削除できるように、すべての[公開API](../PUBLISH_API_ja-JP.md)を削除します。
- [npx cdk deploy](../README.md#deploy-using-cdk)を実行し、Auroraクラスターの置き換えをトリガーし、すべてのベクターアイテムを削除します。
- [データベース移行ガイド](./DATABASE_MIGRATION_ja-JP.md)に従って、ベクターアイテムを復元します。
- ユーザーが既存のボット（知識を持つRAGボット）を利用できることを確認します。

### CreatingBotAllowed権限の付与

- デプロイ後、すべてのユーザーは新しいボットを作成できなくなります。
- 特定のユーザーにボットの作成を許可する場合、管理コンソールまたはCLIを使用して、それらのユーザーを `CreatingBotAllowed` グループに追加します。
- ユーザーがボットを作成できることを確認します。ユーザーは再ログインする必要があることに注意してください。