# マイグレーションガイド (v0 から v1)

既に以前のバージョン（~`0.4.x`）の Bedrock Claude Chat を使用している場合、マイグレーションのために以下の手順に従う必要があります。

## なぜこの作業を行う必要があるのでしょうか?

この主要な更新には、重要なセキュリティ更新が含まれています。

- ベクターデータベース（つまり、Aurora PostgreSQLの pgvector）のストレージが現在暗号化されており、デプロイ時に置き換えがトリガーされます。これは、既存のベクターエントリが削除されることを意味します。
- ボット作成権限を制限するために、`CreatingBotAllowed` Cognitoユーザーグループを導入しました。現在、既存のユーザーはこのグループに属していないため、ボット作成権限を付与するには、手動で権限を添付する必要があります。参照: [ボットのパーソナライズ](../../README.md#bot-personalization)

## 前提条件

[データベース移行ガイド](./DATABASE_MIGRATION_ko-KR_ja-JP.md)を読み、アイテムの復元方法を決定してください。

## 手順

### ベクターストレージの移行

- ターミナルを開き、プロジェクトディレクトリに移動
- デプロイするブランチをフェッチします。目的のブランチ（この場合は `v1`）に切り替え、最新の変更を取得します：

```sh
git fetch
git checkout v1
git pull origin v1
```

- DMSで項目を復元するには、パスワードのローテーションを無効にし、データベースアクセス用のパスワードを記録する必要があります。マイグレーションスクリプト（[migrate_v0_v1.py](./migrate_v0_v1.py)）で復元する場合、パスワードを記録する必要はありません。
- CloudFormationが既存のAuroraクラスターを削除できるように、すべての[公開されたAPI](../PUBLISH_API_ko-KR_ja-JP.md)を削除します。
- [npx cdk deploy](../README.md#deploy-using-cdk)を実行すると、Auroraクラスターの置き換えがトリガーされ、すべてのベクター項目が削除されます。
- [データベース移行ガイド](./DATABASE_MIGRATION_ko-KR_ja-JP.md)に従って、ベクター項目を復元します。
- ユーザーが既存のボット（RAGボット）を利用できることを確認します。

### CreatingBotAllowed 権限の付与

- デプロイ後、すべてのユーザーは新しいボットを作成できなくなります。
- 特定のユーザーがボットを作成できるようにするには、管理コンソールまたはCLIを使用して、そのユーザーを `CreatingBotAllowed` グループに追加します。
- ユーザーがボットを作成できることを確認します。ユーザーは再ログインする必要があります。