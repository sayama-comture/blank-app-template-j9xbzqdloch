# マイグレーションガイド (バージョン0からバージョン1へ)

既に以前のバージョン (~`0.4.x`)のBedrock Claude Chatを使用している場合は、以下の手順に従ってマイグレーションを行う必要があります。

## なぜこれを行う必要があるのか?

このメインアップデートには、重要なセキュリティ更新が含まれています。

- ベクターデータベースストレージ（Aurora PostgreSQLの`pgvector`など）が現在暗号化されており、デプロイ時に交換されます。これは、既存のベクター要素が削除されることを意味します。
- ボットの作成を制限するために、Cognitoユーザーグループ`CreatingBotAllowed`を導入しました。既存のユーザーはこのグループに属していないため、ボットを作成できるようにする場合は、手動で権限を割り当てる必要があります。詳細は: [ボットのカスタマイズ](../../README.md#bot-personalization)

## 前提条件

[データベース移行ガイド](./DATABASE_MIGRATION_pl-PL_ja-JP.md)を参照し、アイテムの復元方法を決定してください。

## Kroki

### ベクターストレージの移行

- ターミナルを開き、プロジェクトディレクトリに移動します
- デプロイしたいブランチをダウンロードします。目的のブランチ（この場合は`v1`）に切り替え、最新の変更をプルします：

```sh
git fetch
git checkout v1
git pull origin v1
```

- DMSを使用して要素を復元する場合、パスワードのローテーションを無効にし、データベースアクセスパスワードをメモしてください。移行スクリプト（[migrate_v0_v1.py](./migrate_v0_v1.py)）を使用して復元する場合、パスワードをメモする必要はありません。
- CloudFormationが既存のAuroraクラスターを削除できるように、[公開されたAPIインターフェース](../PUBLISH_API_pl-PL_ja-JP.md)をすべて削除します。
- [npx cdk deploy](../README.md#deploy-using-cdk)を実行し、Auroraクラスターを交換し、すべてのベクター要素を削除します。
- [データベース移行ガイド](./DATABASE_MIGRATION_pl-PL_ja-JP.md)に従って、ベクター要素を復元します。
- ユーザーが既存のボット（RAGボットなど）を使用できることを確認します。

### CreatingBotAllowedパーミッションの追加

- デプロイ後、すべてのユーザーは新しいボットを作成できなくなります。
- 特定のユーザーがボットを作成できるようにする場合は、管理コンソールまたはCLIを使用して、これらのユーザーを`CreatingBotAllowed`グループに追加します。
- ユーザーがボットを作成できることを確認します。ユーザーは再ログインする必要があることに注意してください。